# BLOCKCHAIN CASINO
## Ставки за токены на платформе Ethereum

1. [Описание системы](#desc)
2. [Get started](#get-started)
3. [Примеры](#examples)


<a name="desc"></a>
## Описание системы. 

![alt text](https://github.com/pleshakoff/blockchain-casino/blob/master/blockchain-casino.png?raw=true"")

Система реализующая азартную игру по угадыванию чисел. Игра ведется на монеты Lucky Coin, 
которые приобретаются за ether.   

В качестве эмуляции блокчейна в текущей реализации используентся локальная нода geth.
Для управления коинами используеется смарт-контракт написанный на языке Solidity, 
задеплоннный в блокчейн.   
Игровая логика реализована в приложении на Java+Spring Boot.

Игра заключается в том что пользователь пытается угадать число от 1 до 50. 
При этом он должен сделать ставку(в коинах). Если число угадано, 
на счет пользователя переводятся коины в размере его ставки, если число не угадано,
то со счета пользователя снимается ставка. 

Начальные коины на счет пользователя переводятся, если на адрес смарт контракта отправить эфир. 
За один эфир начисляется 100 коинов. 
Размер ставок ограничен только счетом игрока или запасами казино.

Игрок может закрыть счет и все его коины будут переведены в эфир и отправлены ему на счет. 

К сожалению казино работает по принципу финансовой пирамиды, 
не вкладывая свои средства.
При обмене токенов обратно в эфир выигрыш выплачивается за счет средств, 
внесенных другими игроками. 
Поэтому, если игрок попытается выйти и сумма коинов у него на счету переведенная в эфир,
превышает запасы эфира у казино, то казино ему откажет :)          
     

### Самрт-контракт 

https://github.com/pleshakoff/blockchain-casino/blob/master/contract/contracts/Lucky.sol

При переводе эфира на адрес смарт-контракта, зачисляет на счет отправителя игровые 
монеты Lucky Coin. 

Так же смарт-контракт возвращает данные о баллансе каждого держателя коинов. 

У владельца контракта есть возможность отправить и снять данные со счетов держателей коинов, 
что используется при игре на коины. 

Есть возможность перевести коины обратно в эфир.     

Реализует основные методы интерфейса ERC20, что позволяет подключиться к смарт контракту 
через кошелек и например посмотреть балланс (подробнее в [примерах](#examples)).  

### Сервер

https://github.com/pleshakoff/blockchain-casino/tree/master/server

С API можно работать через swagger(подробнее в разделе [API](#api))

Сервер взаимодействует со смарт-контрактом посредством специального адаптера.
Технология такая: 
* смарт-контракт компилируется truffle
* в резултатае формируется JSON, описывающий сигнатуры методов смарт-контракта
* web3j на базе JSON генерирует java класс   
 
При запуске сервер подключается к блокчейну и деплоит смарт-контракт. 
В текущей тестовой реализации перезапуск сервера, запускает деплой контракта по новой.
Сделано для упрощения развертывания системы.   

Так же сервер реализует игровую динамику и вызывает методы смарт-контракта 
для обеспечения расчетов по ставкам.     
 
Помимо этого у сервера есть служебный метод. Может подключаться непосредственно к блокчейну и 
возвращаеть баланс эфира у заданного адреса.          
  
    
<a name="api"></a>            
#### API 
 
http://localhost:8080/api/v1/swagger-ui.html#/
   
В API доступны следующее группы методов 

* Contract. Возвращает адрес контракта, который ему выдается после деплоя.
Это адрес используется для перечисления эфира. Или подключения токена в кошельке. 
* Game. Получения данных о балансе игрока. Непосредственно игра. Закрытие счета. 
* Blockchain. Служебный метод позволяющий посмотреть баланс эфира по заданному адресу.

#### Реализация 

Пакеты:

* [contract](https://github.com/pleshakoff/blockchain-casino/tree/master/server/src/main/java/com/casino/contract). 
Врапер контракта и сервис для работы с ним    
* [game](https://github.com/pleshakoff/blockchain-casino/tree/master/server/src/main/java/com/casino/game). 
Реализация игровой динамики.   
* [blockchain](https://github.com/pleshakoff/blockchain-casino/tree/master/server/src/main/java/com/casino/blockchain). 
Доступ к блокчейну.  
* [credentials](https://github.com/pleshakoff/blockchain-casino/tree/master/server/src/main/java/com/casino/credentials). 
Сервис для получения credentials владельца ноды. В текущей тестовой реализации JSON-файл 
просто лежит в том же контйнере.     

<a name="get-started"></a>
## Get started 

Для развертывания системы необходимо выполнить следующие шаги 

Создаем  приватную сеть для докера с маской 172.77.0.0

`docker network create --subnet=172.77.0.0/16 casino-net`

Запускаем ноду geth. Устанавливаем фиксированный IP 172.77.0.2 для контейнера 

`docker run --name bc-geth  --rm -it -p 127.0.0.1:8545:8545 --net casino-net --ip 172.77.0.2 pleshakoff/blockchain-casino-geth:1.0.0`

Нода запускается и начинает формировать DAG, это происходит 2-3 минуты, потом стартует майнинг. 

Запускаем сервер. Обратите внимание, ip 172.77.0.2 и порт ноды geth передается в параметрах 

`docker run --name bc-server --rm -p 8080:8080 --net casino-net pleshakoff/blockchain-casino-server:1.0.0 -e --blockchain.host=172.77.0.2 --blockchain.port=8545`

Сервер при запуске попытается задеплоить контракт, это произойдет как только стартует майнинг.

После того как сервер сартует надо получить адрес смарт-контракта http://localhost:8080/api/v1/address

Swagger тут http://localhost:8080/api/v1/swagger-ui.html#/ 

<a name="examples"></a>
## Примеры

Для тестировоания в блокчейне заведено два аккаунта: 

0xe7b0600cd184432527b3ea401eebb5dc5d05b855 

Адрес владельца ноды. На счету при запуске 1000 эфиров, туда же переводится вознаграждение от майнинга. 
Владелец смарт-контракта. Только этот пользователь может осуществлять манипуляции с коинами, 
при рассчетах по ставкам.  
[JSON](https://github.com/pleshakoff/blockchain-casino/blob/master/geth/UTC--2020-02-15T23-15-17.397221865Z--e7b0600cd184432527b3ea401eebb5dc5d05b855).
 
0x1ad4F70b6a49d0448C1f1392db93793BFF540E2b 

Обычный пользователь. На счету при запуске 100 эфиров.
Использеутся для тестирования.  
[JSON](https://github.com/pleshakoff/blockchain-casino/blob/master/geth/UTC--2020-02-23T03-54-10.906285725Z--1ad4f70b6a49d0448c1f1392db93793bff540e2b).


###Покупка коинов 

Я использовал расширение для хрома https://metamask.io
Он позволяет подключиться к локальной ноде. 

Есть один нюанс, при перезапуске ноды, если уже был подключен, появляются проблемы с транзакциями.
Спасает переустановка плагина. 











  
 
 
